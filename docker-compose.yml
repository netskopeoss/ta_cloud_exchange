services:
  rabbitmq-stats:
    image: index.docker.io/${RABBITMQ_TAG}
    user: "1001:1001"
    env_file:
      - ${ENV_FILE:-.env}
      - ${LOCATION}
    environment:
      - RABBITMQ_NODENAME=rabbit@rabbitmq-stats
      - RABBITMQ_DEFAULT_USER=user
      - RABBITMQ_DISK_FREE_LIMIT_ABSOLUTE=1
      - RABBITMQ_RAM_RESOURCES=${RABBITMQ_RAM_RESOURCES:-3072}
      - RESTART_ON_HEALTHCHECK_FAILURE=false
      - HEALTHCHECK_FREE_DISK_SPACE_LIMIT=40
      - HEALTHCHECK_FREE_DISK_SPACE_PATH=/var/lib/rabbitmq
    restart: always
    volumes:
      - ./data/healthcheck.sh:/opt/healthcheck.sh:z
      - ./data/rabbitmq/custom.conf:/etc/rabbitmq/conf.d/custom.conf:z
      - ./data/rabbitmq/data:/var/lib/rabbitmq/mnesia:z
      - ./data/database-init/load_env.sh:/opt/load_env.sh:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs/tls_cert.crt:/etc/rabbitmq/conf.d/rabbitmq_cert.crt:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs/tls_cert_key.key:/etc/rabbitmq/conf.d/rabbitmq_cert_key.key:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs/tls_cert_ca.crt:/etc/rabbitmq/conf.d/rabbitmq_cert_ca.crt:z
    logging:
      options:
        max-size: "10m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: ${RABBITMQ_RAM_RESOURCES:-3072}M
    healthcheck:
      test: ["CMD-SHELL", "/opt/healthcheck.sh"]
      interval: 12h
      timeout: 30s
      retries: 3
    entrypoint:
      [
        "/bin/bash",
        "-c",
        'source /opt/load_env.sh && echo ${RABBITMQ_COOKIE} > /var/lib/rabbitmq/.erlang.cookie && chmod 600 /var/lib/rabbitmq/.erlang.cookie && docker-entrypoint.sh rabbitmq-server'
      ]
  mongodb-primary:
    image: index.docker.io/${MONGO_TAG}
    user: mongodb
    env_file:
      - ${ENV_FILE:-.env}
      - ${LOCATION}
    volumes:
      - ./data/mongo-data/data/db:/data/db:z
      - ./data/database-init/mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh:z
      - ./data/database-init/load_env.sh:/opt/load_env.sh:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs/tls_cert.crt:/opt/tls_cert.pem:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs/tls_cert_key.pem:/opt/tls_cert_key.pem:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs/tls_cert_ca.crt:/opt/tls_cert_ca.crt:z
    environment:
      - MONGODB_ADVERTISED_HOSTNAME=mongodb-primary
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_DATABASE=cte
      - MONGODB_USERNAME=cteadmin
      - HTTP_PROXY=${CORE_HTTP_PROXY}
      - HTTPS_PROXY=${CORE_HTTPS_PROXY}
    restart: always
    logging:
      options:
        max-size: "10m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: ${MONGODB_RAM_RESOURCES:-3072}M
    entrypoint:
      [
        "/bin/bash",
        "-c",
        "source /opt/load_env.sh && docker-entrypoint.sh mongod --tlsMode preferTLS --tlsCertificateKeyFile /opt/tls_cert_key.pem --tlsCAFile /opt/tls_cert_ca.crt --tlsDisabledProtocols TLS1_0,TLS1_1"
      ]
  core:
    image: index.docker.io/${CORE_TAG}
    env_file:
      - ${ENV_FILE:-.env}
      - ${LOCATION}
    volumes:
      - ./data/custom_plugins:/opt/netskope/plugins/custom_plugins:z
      - ./data/ca_certs:/usr/local/share/ca-certificates:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs:/usr/local/share/ca-certificates/ca.crt:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs:/usr/local/share/ca-certificates/mongodb_rabbitmq_certs:z
      - ./data/ssl_certs:/opt/certs:z
      - ./data/rabbitmq/data:/var/lib/rabbitmq:z
      - ./data/files-data:/etc/files-data:z
      - nfs_repos:/opt/netskope/repos
      - nfs_plugins:/opt/netskope/plugins
      - ./data/healthcheck.sh:/opt/healthcheck.sh:z
      - ./data/database-init/load_env.sh:/opt/load_env.sh:z
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - CHAINLIT_AUTH_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=HS256
      - ENABLE_CELERY_BEAT=true
      - DOCKER_USERNAME=${DOCKER_USERNAME:-}
      - DOCKER_PASSWORD=${DOCKER_PASSWORD:-}
      - CORE_TAG=${CORE_TAG}
      - UI_TAG=${UI_TAG}
      - CORE_LATEST_VERSION_TAG=${CORE_LATEST_VERSION_TAG}
      - UI_LATEST_VERSION_TAG=${UI_LATEST_VERSION_TAG}
      - WATCHTOWER_HTTP_API_TOKEN=${WATCHTOWER_TOKEN}
      - ANALYTICS_BASE_URL=https://reporting.netskope.tech
      - ANALYTICS_TOKEN=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpbnN0YWxsYXRpb25faWQiOiJjMDAyIn0.w8SVrTcDjk8PkR4IcbWGwOyf6-OWfCUyOoCTgZvqHqc
      - ANALYTICS_SERVER_CONNECTIVITY=${ANALYTICS_SERVER_CONNECTIVITY:-True}
      - MAX_MAINTENANCE_WINDOW_MINUTES=${MAX_MAINTENANCE_WINDOW_MINUTES}
      - PULL_THREADS=${PULL_THREADS}
      - MAX_WAIT_ON_LOCK_IN_MINUTES=${MAX_WAIT_ON_LOCK_IN_MINUTES}
      - HTTP_PROXY=${CORE_HTTP_PROXY}
      - HTTPS_PROXY=${CORE_HTTPS_PROXY}
      - BETA_OPT_IN=${BETA_OPT_IN}
      - REQUESTS_TIMEOUT=${REQUESTS_TIMEOUT}
      - POPEN_TIMEOUT=${POPEN_TIMEOUT}
      # - PLUGIN_TIMEOUT_MINUTES=240
      # - ENABLE_DEBUG=True
      # - UI_SERVICE_NAME=
      # - THRESHOLD_FOR_IDLE_CHECK_IN_MINUTES=
      - RESTART_ON_HEALTHCHECK_FAILURE=false
      - HEALTHCHECK_FREE_DISK_SPACE_LIMIT=40
      - HEALTHCHECK_FREE_DISK_SPACE_PATH=/var/lib/rabbitmq
    restart: always
    logging:
      options:
        max-size: "10m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: ${CORE_RAM_RESOURCES:-3072}M
    healthcheck:
      test: ["CMD-SHELL", "/opt/healthcheck.sh"]
      interval: 12h
      timeout: 30s
      retries: 3
    depends_on:
      - mongodb-primary
      - rabbitmq-stats
    entrypoint: ["/bin/bash", "-c", "source /opt/load_env.sh && /opt/start.sh"]
  ui:
    image: index.docker.io/${UI_TAG}
    restart: always
    env_file:
      - ${ENV_FILE}
      - ${LOCATION}
    environment:
      - CE_API_URL=http://core
      - CE_API_PORT=8000
      - TLS_VERSION=${TLS_VERSION:-TLSv1.3}
      - CE_MANAGEMENT_PORT=${CE_MANAGEMENT_PORT:-8000}
    volumes:
      - ./data/ssl_certs:/tmp/ssl_certs:z
      - ./data/ssl_certs/mongodb_rabbitmq_certs/:/data/ssl_certs/mongodb_rabbitmq_certs/
      - ./data/database-init/load_env.sh:/opt/load_env.sh:z
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - ${UI_PORT}:3000
    links:
      - core
    logging:
      options:
        max-size: "10m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: ${UI_RAM_RESOURCES:-256}M
    entrypoint: ["/bin/bash", "-c", "source /opt/load_env.sh && ./start.sh"]
volumes:
  nfs_repos:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/repos
  nfs_plugins:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/plugins
